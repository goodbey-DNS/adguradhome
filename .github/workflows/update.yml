name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 22 * * *'  # UTC时间22点（北京时间6点）自动检查
  workflow_dispatch:      # 手动触发，无参数

permissions:
  contents: write  # 需要创建release
  issues: write    # 需要创建issue

env:
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  TIMEOUT: 30
  MAX_RETRIES: 3
  MIN_SIZE_MB: 10
  MAX_SIZE_MB: 50

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20          # 防止退避超时
    concurrency:
      group: adguard-update
      cancel-in-progress: false

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq jq curl gh
          jq --version >/dev/null || exit 1
          curl --version >/dev/null || exit 1
          gh --version >/dev/null || exit 1

      # 1. 获取官方最新版本
      - name: Get official version
        id: official
        run: |
          set -euo pipefail
          VERSION=""
          for i in $(seq 1 ${{ env.MAX_RETRIES }}); do
            CODE=$(curl -s -w "%{http_code}" --max-time ${{ env.TIMEOUT }} \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -o /tmp/official.json \
              "https://api.github.com/repos/${{ env.REPO }}/releases/latest" 2>/dev/null || echo "000")
            
            if [[ "$CODE" == "200" ]]; then
              if VERSION=$(jq -r '.tag_name // empty' /tmp/official.json | sed 's/^v//'); then
                if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                  break
                fi
              fi
            elif [[ "$CODE" == "404" ]]; then
              echo "Repository or release not found"
              exit 1
            elif [[ "$CODE" == "429" ]]; then
              echo "API rate limit hit, will retry with longer delay"
              sleep $(( 2 ** i < 120 ? 2 ** i : 120 ))
              continue
            fi
            
            if [[ $i -lt ${{ env.MAX_RETRIES }} ]]; then
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
            fi
          done
          
          if [[ -z "$VERSION" ]]; then
            echo "::error::Failed to get version after ${{ env.MAX_RETRIES }} retries"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "✓ Latest version: v$VERSION"

      # 2. 本地版本（无则none）
      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          RESP=$(curl -s -w "\n%{http_code}" --max-time ${{ env.TIMEOUT }} \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v-latest" 2>/dev/null || true)
          
          Code=$(echo "$RESP" | tail -n1)
          Body=$(echo "$RESP" | head -n-1)
          
          if [[ "$Code" == "200" ]]; then
            # 优先从release name提取，失败则从tag_name回退
            Current=$(echo "$Body" | jq -r '.name // "none"' | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n1 | sed 's/^v//')
            if [[ ! "$Current" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              Current=$(echo "$Body" | jq -r '.tag_name // "none"' | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -n1 | sed 's/^v//')
            fi
            [[ "$Current" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || Current="none"
          else
            Current="none"
          fi
          
          echo "current=${Current:-none}" >> $GITHUB_OUTPUT
          echo "✓ Current version: ${Current:-none}"

      # 3. 决策（手动触发=强制更新）
      - name: Decide action
        id: decide
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Current version: ${{ steps.current.outputs.current }}"
          echo "Official version: ${{ steps.official.outputs.version }}"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]] || \
             [[ "${{ steps.current.outputs.current }}" != "${{ steps.official.outputs.version }}" ]]; then
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "✓ Update needed: ${{ steps.current.outputs.current }} → ${{ steps.official.outputs.version }}"
          else
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "✓ Already latest: v${{ steps.official.outputs.version }}"
          fi

      # 4. 下载并验证（损坏即重试）
      - name: Download
        if: steps.decide.outputs.should_update == 'true'
        id: download
        run: |
          set -euo pipefail
          cd ${{ github.workspace }}
          
          BASE="https://github.com/${{ env.REPO }}/releases/download/v${{ steps.official.outputs.version }}"
          FILE="AdGuardHome_${{ env.ARCH }}.tar.gz"
          SHA="AdGuardHome_${{ env.ARCH }}.tar.gz.sha256"
          
          SUCCESS=false
          echo "Starting download for version ${{ steps.official.outputs.version }}"
          
          for i in $(seq 1 ${{ env.MAX_RETRIES }}); do
            echo "Download attempt $i/${{ env.MAX_RETRIES }}..."
            
            # 下载主文件
            if ! curl -L --fail --max-time 300 -o "$FILE" "$BASE/$FILE"; then
              echo "Failed to download: $FILE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            
            # 尝试下载SHA256文件（可选）
            SHA_AVAILABLE=true
            if ! curl -L --fail --max-time ${{ env.TIMEOUT }} -o "$SHA" "$BASE/$SHA" 2>/dev/null; then
              echo "SHA256 file not found (this is normal for some releases): $SHA"
              SHA_AVAILABLE=false
              rm -f "$SHA" 2>/dev/null || true
            fi
            
            # 验证主文件存在且非空
            if [[ ! -f "$FILE" ]]; then
              echo "File not found: $FILE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            if [[ ! -s "$FILE" ]]; then
              echo "Empty file: $FILE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            
            # 如果SHA256文件可用，则进行校验
            if [[ "$SHA_AVAILABLE" == "true" ]]; then
              if [[ ! -f "$SHA" ]]; then
                echo "SHA256 file not found: $SHA"
                sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
                continue
              fi
              if [[ ! -s "$SHA" ]]; then
                echo "Empty SHA256 file: $SHA"
                sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
                continue
              fi
              
              # 提取并验证SHA256
              EXPECTED=$(grep -oE '[a-fA-F0-9]{64}' "$SHA" | head -n1) || true
              if [[ -z "$EXPECTED" || ! "$EXPECTED" =~ ^[a-fA-F0-9]{64}$ ]]; then
                echo "Cannot extract valid SHA256 from $SHA"
                sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
                continue
              fi
              
              ACTUAL=$(sha256sum "$FILE" | awk '{print $1}')
              if [[ "$EXPECTED" != "$ACTUAL" ]]; then
                echo "SHA256 mismatch: expected $EXPECTED, got $ACTUAL"
                sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
                continue
              fi
              echo "✓ SHA256 verification passed"
            else
              echo "ℹ SHA256 file not available, skipping SHA256 verification"
            fi
            
            # 验证archive完整性
            if ! tar -tzf "$FILE" >/dev/null 2>&1; then
              echo "Invalid archive: $FILE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            echo "✓ Archive integrity check passed"
            
            # 验证文件大小
            SIZE=$(stat -c%s "$FILE" 2>/dev/null || echo 0)
            MIN_SIZE=$(( ${{ env.MIN_SIZE_MB }} * 1024 * 1024 ))
            MAX_SIZE=$(( ${{ env.MAX_SIZE_MB }} * 1024 * 1024 ))
            echo "File size: $SIZE bytes (min: $MIN_SIZE, max: $MAX_SIZE)"
            if [[ $SIZE -le $MIN_SIZE ]]; then
              echo "File too small: $SIZE < $MIN_SIZE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            if [[ $SIZE -ge $MAX_SIZE ]]; then
              echo "File too large: $SIZE > $MAX_SIZE"
              sleep $(( 2 ** i < 60 ? 2 ** i : 60 ))
              continue
            fi
            
            # 全部通过
            SUCCESS=true
            break
          done
          
          if [[ "$SUCCESS" != "true" ]]; then
            echo "Download failed after ${{ env.MAX_RETRIES }} attempts"
            exit 1
          fi
          
          [[ -f "$FILE" ]] || exit 1
          echo "filename=$FILE" >> $GITHUB_OUTPUT
          echo "✓ Download and verification passed"
          echo "File: $FILE, Size: $(stat -c%s "$FILE" 2>/dev/null || echo 0) bytes"

      # 5. 原子发布（fixed URL）
      - name: Publish
        if: steps.download.outputs.filename != ''
        run: |
          set -euo pipefail
          
          # 如果release已存在，先删除（忽略错误）
          if gh release view v-latest >/dev/null 2>&1; then
            echo "Existing release found, deleting..."
            gh release delete v-latest --yes --cleanup-tag 2>/dev/null || true
          fi
          
          # 创建新release
          gh release create v-latest \
            --title "AdGuardHome v${{ steps.official.outputs.version }}" \
            --notes "Auto-update to v${{ steps.official.outputs.version }}" \
            "${{ steps.download.outputs.filename }}"
          
          echo "✓ Release published successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 6. 幂等清理（永不失败）
      - name: Cleanup
        if: always()
        run: |
          # 仅删除本次下载的文件，避免误删
          rm -f "${{ github.workspace }}/AdGuardHome_${{ env.ARCH }}.tar.gz" 2>/dev/null || true
          rm -f "${{ github.workspace }}/AdGuardHome_${{ env.ARCH }}.tar.gz.sha256" 2>/dev/null || true
          echo "✓ Cleanup completed"

      # 7. 失败通知
      - name: Notify on failure
        if: failure()
        run: |
          TIMESTAMP=$(date +%Y-%m-%d-%H)
          TITLE="AdGuardHome Update Failed - $TIMESTAMP"
          BODY="## Auto-update workflow failed

          **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          **Official Version:** ${{ steps.official.outputs.version }}
          
          **Current Version:** ${{ steps.current.outputs.current }}
          
          **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          Please check the workflow logs for details."
          
          # 搜索相同时间戳的issue（更精确）
          ISSUE_NUMBER=$(gh issue list --search "AdGuardHome Update Failed - $TIMESTAMP in:title" --state open --json number --jq '.[0].number')
          if [[ -n "$ISSUE_NUMBER" ]]; then
            echo "Updating existing issue #$ISSUE_NUMBER"
            gh issue comment "$ISSUE_NUMBER" --body "$BODY"
          else
            echo "Creating new issue"
            gh issue create --title "$TITLE" --body "$BODY" --label "bug"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
