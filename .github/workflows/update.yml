name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 22 * * *'  # 6 AM Beijing Time
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version is current'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

permissions:
  contents: write

env:
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  TIMEOUT: 30

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    concurrency:
      group: adguard-update
      cancel-in-progress: false
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update -qq >/dev/null
          sudo apt-get install -y -qq jq curl >/dev/null

      # 核心：内联所有变量，不依赖export
      - name: Get latest version
        id: version
        run: |
          for i in 1 2 3; do
            VERSION=$(curl -s --fail --max-time 30 \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ env.REPO }}/releases/latest" | \
              jq -r '.tag_name' | sed 's/^v//') && break
            sleep $((2 ** i))
          done
          echo "version=${VERSION:-}" >> $GITHUB_OUTPUT

      # 核心：直接检查，不存储中间变量
      - name: Get current version
        id: current
        run: |
          CURRENT=$(curl -s --fail --max-time 30 \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v-latest" | \
            jq -r '.name // "none"' | sed 's/^.*v\([0-9.]*\).*$/\1/') || echo "none"
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

      - name: Check update
        id: check
        run: |
          if [[ "${{ steps.current.outputs.current }}" == "none" ]] || \
             [[ "${{ steps.current.outputs.current }}" != "${{ steps.version.outputs.version }}" ]] || \
             [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
          fi

      # 核心：下载-验证-失败即退出，不复杂判断
      - name: Download
        if: steps.check.outputs.needs_update == 'true'
        id: download
        run: |
          cd ${{ github.workspace }}
          rm -f AdGuardHome_${{ env.ARCH }}.tar.gz
          
          URL="https://github.com/${{ env.REPO }}/releases/download/v${{ steps.version.outputs.version }}/AdGuardHome_${{ env.ARCH }}.tar.gz"
          
          for i in 1 2 3; do
            curl -L --fail --max-time 300 -o AdGuardHome_${{ env.ARCH }}.tar.gz "$URL" && \
            tar -tzf AdGuardHome_${{ env.ARCH }}.tar.gz >/dev/null && \
            break
            rm -f AdGuardHome_${{ env.ARCH }}.tar.gz
            sleep $((2 ** i))
          done || exit 1
          
          echo "filename=AdGuardHome_${{ env.ARCH }}.tar.gz" >> $GITHUB_OUTPUT

      # 核心：原子操作，删除失败也继续
      - name: Update release
        if: steps.download.outputs.filename
        run: |
          gh release view v-latest >/dev/null 2>&1 && \
            gh release delete v-latest --yes --cleanup-tag || true
          
          gh release create v-latest \
            --title "AdGuardHome v${{ steps.version.outputs.version }}" \
            --notes "## AdGuardHome v${{ steps.version.outputs.version }}

**URL:** https://github.com/${{ github.repository }}/releases/download/v-latest/${{ steps.download.outputs.filename }}" \
            ${{ steps.download.outputs.filename }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: rm -f ${{ github.workspace }}/AdGuardHome_*.tar.gz
