name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  TIMEOUT: 30
  RETRIES: 3

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: adguard-update
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl

      - name: Get latest version
        id: version
        run: |
          get_latest_tag() {
            curl -s --max-time ${{ env.TIMEOUT }} \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$1/releases/latest" 2>&1 | \
              jq -r '.tag_name // empty' 2>/dev/null
          }
          
          for i in $(seq 1 ${{ env.RETRIES }}); do
            TAG_NAME=$(get_latest_tag "${{ env.REPO }}")
            if [[ -n "$TAG_NAME" ]]; then
              VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
              echo "Latest version: $VERSION"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            [[ $i -lt ${{ env.RETRIES }} ]] && sleep $((2 ** i))
          done
          
          echo "Error: Cannot get version after ${{ env.RETRIES }} attempts"
          exit 1

      - name: Get current version
        id: current
        run: |
          get_current_tag() {
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time ${{ env.TIMEOUT }} \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" 2>&1)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            [[ "$HTTP_CODE" == "404" ]] && echo "none" && return 0
            
            TAG_NAME=$(echo "$BODY" | jq -r '.tag_name // "none"' 2>/dev/null)
            [[ "$TAG_NAME" == "null" ]] || [[ "$TAG_NAME" == "none" ]] && echo "none" && return 0
            
            VERSION=$(echo "$TAG_NAME" | sed 's/^v//')
            [[ "$VERSION" =~ ^[0-9]+(\.[0-9]+){1,3}$ ]] && echo "$VERSION" || echo "none"
          }
          
          for i in $(seq 1 ${{ env.RETRIES }}); do
            CURRENT=$(get_current_tag)
            if [[ -n "$CURRENT" ]]; then
              echo "Current version: $CURRENT"
              echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            [[ $i -lt ${{ env.RETRIES }} ]] && sleep $((2 ** i))
          done
          
          echo "current=none" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        id: compare
        run: |
          version_to_int() {
            local version="${1#v}"
            [[ "$version" =~ ^[0-9]+(\.[0-9]+){1,3}$ ]] || return 1
            
            IFS='.' read -r -a parts <<< "$version"
            printf "%06d%06d%06d%06d" \
              "${parts[0]:-0}" "${parts[1]:-0}" "${parts[2]:-0}" "${parts[3]:-0}"
          }
          
          LATEST="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          
          if [[ "$CURRENT" == "none" ]]; then
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "Update: No current version"
          else
            LATEST_INT=$(version_to_int "$LATEST")
            CURRENT_INT=$(version_to_int "$CURRENT")
            
            if [[ "$LATEST_INT" -gt "$CURRENT_INT" ]]; then
              echo "needs_update=true" >> "$GITHUB_OUTPUT"
              echo "Update: $CURRENT -> $LATEST"
            else
              echo "needs_update=false" >> "$GITHUB_OUTPUT"
              echo "Latest: v$LATEST"
            fi
          fi

      - name: Download AdGuardHome
        if: steps.compare.outputs.needs_update == 'true'
        id: download
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="AdGuardHome_${{ env.ARCH }}.tar.gz"
          SHA256SUMS="AdGuardHome_${{ env.ARCH }}.tar.gz.sha256"
          BASE_URL="https://github.com/${{ env.REPO }}/releases/download/v${VERSION}"
          
          for i in $(seq 1 ${{ env.RETRIES }}); do
            if curl -L --max-time 300 --retry 3 --retry-delay 5 -o "$FILENAME" "${BASE_URL}/${FILENAME}" && \
               curl -L --max-time 30 --retry 3 --retry-delay 5 -o "$SHA256SUMS" "${BASE_URL}/${SHA256SUMS}"; then
              [[ -f "$FILENAME" && -f "$SHA256SUMS" ]] && break
            fi
            
            [[ $i -eq ${{ env.RETRIES }} ]] && echo "Error: Download failed" && exit 1
            rm -f "$FILENAME" "$SHA256SUMS"
            sleep $((2 ** i))
          done
          
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "sha256file=$SHA256SUMS" >> "$GITHUB_OUTPUT"

      - name: Verify download integrity
        if: steps.download.outcome == 'success'
        run: |
          FILENAME="${{ steps.download.outputs.filename }}"
          SHA256FILE="${{ steps.download.outputs.sha256file }}"
          
          [[ -f "$SHA256FILE" && -f "$FILENAME" ]] || { echo "Error: Required files not found"; exit 1; }
          
          EXPECTED_SHA=$(grep -oE '^[a-fA-F0-9]{64}' "$SHA256FILE" | head -n1)
          ACTUAL_SHA=$(sha256sum "$FILENAME" | awk '{print $1}')
          [[ "$EXPECTED_SHA" == "$ACTUAL_SHA" ]] || { echo "Error: SHA256 verification failed"; exit 1; }
          
          tar -tzf "$FILENAME" >/dev/null 2>&1 || { echo "Error: Invalid archive"; exit 1; }
          tar -tzf "$FILENAME" | grep -qE '(^|/)AdGuardHome$' || { echo "Error: Archive does not contain AdGuardHome"; exit 1; }
          
          SIZE=$(stat -c%s "$FILENAME" 2>/dev/null || echo 0)
          [[ $SIZE -ge 10000000 ]] || { echo "Error: File too small (< 10MB)"; exit 1; }
          
          echo "Verification passed"

      - name: Delete old release
        if: steps.download.outcome == 'success'
        continue-on-error: true
        run: |
          CURRENT_VERSION="${{ steps.current.outputs.current }}"
          if [[ "$CURRENT_VERSION" != "none" ]]; then
            if gh release view "v${CURRENT_VERSION}" >/dev/null 2>&1; then
              gh release delete "v${CURRENT_VERSION}" --yes --cleanup-tag
            fi
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new release
        if: steps.download.outcome == 'success'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="${{ steps.download.outputs.filename }}"
          
          [[ -n "$VERSION" && -f "$FILENAME" ]] || { echo "Error: Missing required data"; exit 1; }
          
          SHA256=$(sha256sum "$FILENAME" | cut -d' ' -f1)
          NOTES_FILE=$(mktemp)
          cat > "$NOTES_FILE" <<EOF
          ## AdGuardHome v${VERSION}
          
          **Update time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          **Source:** ${{ env.REPO }}
          
          **Architecture:** ${{ env.ARCH }}
          
          ### Installation
          \`\`\`bash
          tar -xzf ${FILENAME}
          sudo ./AdGuardHome -s install
          \`\`\`
          
          ### Verification
          SHA256: ${SHA256}
          EOF
          
          gh release create "v${VERSION}" \
            --title "AdGuardHome v${VERSION}" \
            --notes-file "$NOTES_FILE" \
            "$FILENAME"
          
          rm -f "$NOTES_FILE"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log execution info
        if: always()
        run: |
          echo "=================================="
          echo "Workflow Execution Summary"
          echo "=================================="
          echo "Repository     : ${{ github.repository }}"
          echo "Latest Version : ${{ steps.version.outputs.version }}"
          echo "Current Version: ${{ steps.current.outputs.current }}"
          echo "Needs Update   : ${{ steps.compare.outputs.needs_update }}"
          echo "Job Status     : ${{ job.status }}"
          echo "Timestamp      : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================="

      - name: Cleanup
        if: always()
        run: rm -f AdGuardHome_*.tar.gz AdGuardHome_*.sha256
