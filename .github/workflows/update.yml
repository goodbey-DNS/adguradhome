name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Get latest version
        id: version
        run: |
          VERSION=$(curl -s --max-time 10 https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest | jq -r '.tag_name' | sed 's/v//')
          if [[ -z "$VERSION" ]]; then
            echo "Error: Cannot get version info"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: Check and update
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          CURRENT=$(curl -s --max-time 10 https://api.github.com/repos/${{ github.repository }}/releases/latest | jq -r '.tag_name' | sed 's/v//')
          if [[ "$CURRENT" != "$VERSION" ]]; then
            echo "Update: $CURRENT -> $VERSION"
            curl -L --max-time 300 "https://github.com/AdguardTeam/AdGuardHome/releases/download/v$VERSION/AdGuardHome_linux_amd64.tar.gz" -o AdGuardHome_linux_amd64.tar.gz
            if [[ ! -f "AdGuardHome_linux_amd64.tar.gz" ]] || [[ $(stat -c%s "AdGuardHome_linux_amd64.tar.gz") -lt 10000000 ]]; then
              echo "Error: File download failed"
              exit 1
            fi
            gh release delete latest --yes || true
            gh release create latest \
              --title "AdGuardHome v$VERSION" \
              --notes "AdGuardHome v$VERSION Update time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" \
              AdGuardHome_linux_amd64.tar.gz
          else
            echo "Already latest version: v$VERSION"
          fi
