name: AdGuardHome Auto Update
# Description: Production-ready workflow for automated AdGuardHome updates with robust error handling,
# intelligent caching, and zero-maintenance operation.

on:
  schedule:
    - cron: '0 22 * * *'  # 6 AM Beijing Time (UTC+8)
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version is current'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']

permissions:
  contents: write
  issues: write

env:
  # Repository settings
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  
  # Network settings
  API_TIMEOUT: 30
  CURL_TIMEOUT: 300
  MAX_RETRIES: 3
  RETRY_BASE_SEC: 5
  RETRY_MAX_SEC: 300
  
  # Security settings
  MIN_SIZE_BYTES: 10000000
  MAX_SIZE_BYTES: 50000000
  
  # Cache settings
  CACHE_VERSION: v1
  CACHE_HOURS: 6

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: adguard-update
      cancel-in-progress: false
    
    steps:
      - name: Setup environment
        run: |
          # Export all env variables to GITHUB_ENV for persistent availability
          {
            echo "REPO=${{ env.REPO }}"
            echo "ARCH=${{ env.ARCH }}"
            echo "API_TIMEOUT=${{ env.API_TIMEOUT }}"
            echo "CURL_TIMEOUT=${{ env.CURL_TIMEOUT }}"
            echo "MAX_RETRIES=${{ env.MAX_RETRIES }}"
            echo "RETRY_BASE_SEC=${{ env.RETRY_BASE_SEC }}"
            echo "RETRY_MAX_SEC=${{ env.RETRY_MAX_SEC }}"
            echo "MIN_SIZE_BYTES=${{ env.MIN_SIZE_BYTES }}"
            echo "MAX_SIZE_BYTES=${{ env.MAX_SIZE_BYTES }}"
            echo "CACHE_VERSION=${{ env.CACHE_VERSION }}"
            echo "CACHE_HOURS=${{ env.CACHE_HOURS }}"
          } >> "$GITHUB_ENV"
          
          # Setup utility functions for all steps
          cat > "$RUNNER_TEMP/workflow_functions.sh" << 'EOF'
          #!/bin/bash
          set -euo pipefail
          
          # Retry with exponential backoff and jitter
          retry() {
            local cmd=("$@")
            local attempt=0
            local delay=0
            
            while (( attempt < MAX_RETRIES )); do
              if "${cmd[@]}"; then
                return 0
              fi
              
              (( attempt++ ))
              if (( attempt >= MAX_RETRIES )); then
                return 1
              fi
              
              delay=$(( RETRY_BASE_SEC ** attempt + RANDOM % 10 ))
              (( delay > RETRY_MAX_SEC )) && delay=$RETRY_MAX_SEC
              
              echo "‚è≥ Retry $attempt/$MAX_RETRIES in ${delay}s..."
              sleep "$delay"
            done
          }
          
          # Safe API call with rate limit detection
          api_call() {
            local url=$1
            local output=$2
            local rate_limit
            
            if curl -s --fail-with-body --max-time "$API_TIMEOUT" \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              -w "%{http_code}" -o "$output" "$url" > "$RUNNER_TEMP/http_code"; then
              
              rate_limit=$(grep -i '^x-ratelimit-remaining:' "$output" | tr -d '\r' | awk '{print $2}')
              if [[ -n "$rate_limit" && "$rate_limit" -lt 10 ]]; then
                echo "‚ö†Ô∏è  Warning: GitHub API rate limit low: $rate_limit remaining"
              fi
              return 0
            fi
            
            echo "‚ùå API call failed: HTTP $(<"$RUNNER_TEMP/http_code")"
            return 1
          }
          
          # Cache-aware version fetch
          get_version_cached() {
            local cache_key=$1
            local cache_file="$RUNNER_TEMP/$cache_key.json"
            local cache_age=$(( $(date +%s) - $(stat -c %Y "$cache_file" 2>/dev/null || echo 0) ))
            
            if [[ -f "$cache_file" && $cache_age -lt $(( CACHE_HOURS * 3600 )) ]]; then
              echo "‚úì Using cached response (${cache_age}s old)"
              cat "$cache_file"
              return 0
            fi
            
            return 1
          }
          
          cache_response() {
            local cache_key=$1
            local response=$2
            mkdir -p "$RUNNER_TEMP"
            echo "$response" > "$RUNNER_TEMP/$cache_key.json"
          }
          
          # Validate file integrity
          verify_archive() {
            local file=$1
            local sha_file=$2
            
            [[ -f "$sha_file" && -f "$file" ]] || return 1
            
            local expected_sha actual_sha
            expected_sha=$(grep -oE '[a-f0-9]{64}' "$sha_file" | head -1 | tr '[:upper:]' '[:lower:]')
            actual_sha=$(sha256sum "$file" | awk '{print $1}' | tr '[:upper:]' '[:lower:]')
            
            [[ -n "$expected_sha" && "$expected_sha" == "$actual_sha" ]]
          }
          EOF
          
          chmod +x "$RUNNER_TEMP/workflow_functions.sh"
          echo "‚úì Environment configured"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl
          echo "jq: $(jq --version), curl: $(curl --version | head -1)"

      - name: Get latest version
        id: version
        run: |
          source "$RUNNER_TEMP/workflow_functions.sh"
          
          cache_key="latest_${REPO//\//_}"
          if response=$(get_version_cached "$cache_key"); then
            VERSION=$(echo "$response" | jq -r '.tag_name // empty' | sed 's/^v//')
          else
            response_file="$RUNNER_TEMP/latest.json"
            retry api_call "https://api.github.com/repos/$REPO/releases/latest" "$response_file"
            response=$(<"$response_file")
            cache_response "$cache_key" "$response"
            VERSION=$(echo "$response" | jq -r '.tag_name // empty' | sed 's/^v//')
          fi
          
          [[ -n "$VERSION" ]] || { echo "‚ùå Failed to get version"; exit 1; }
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "‚úì Latest: v$VERSION"

      - name: Get current version
        id: current
        run: |
          source "$RUNNER_TEMP/workflow_functions.sh"
          
          cache_key="current_${{ github.repository_owner }}_${{ github.event.repository.name }}"
          if response=$(get_version_cached "$cache_key"); then
            CURRENT=$(echo "$response" | jq -r '.name // "none"' | sed 's/^.*v\([0-9.]*\).*$/\1/')
          else
            response_file="$RUNNER_TEMP/current.json"
            api_call "https://api.github.com/repos/${{ github.repository }}/releases/tags/v-latest" "$response_file" || true
            response=$(<"$response_file")
            
            if [[ "$(jq -r '.message // empty' <<< "$response")" == "Not Found" ]]; then
              CURRENT="none"
            else
              CURRENT=$(echo "$response" | jq -r '.name // "none"' | sed 's/^.*v\([0-9.]*\).*$/\1/')
            fi
            cache_response "$cache_key" "$response"
          fi
          
          echo "current=${CURRENT:-none}" >> "$GITHUB_OUTPUT"
          echo "‚úì Current: ${CURRENT:-none}"

      - name: Check update needed
        id: check
        run: |
          LATEST="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          
          if [[ "$CURRENT" == "none" ]] || [[ "$CURRENT" != "$LATEST" ]] || [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "‚úì Update: $CURRENT ‚Üí $LATEST"
          else
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "‚úì No update needed"
          fi

      - name: Download AdGuardHome
        if: steps.check.outputs.needs_update == 'true'
        id: download
        run: |
          source "$RUNNER_TEMP/workflow_functions.sh"
          
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="AdGuardHome_${ARCH}.tar.gz"
          SHA_FILE="AdGuardHome_${ARCH}.tar.gz.sha256"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"
          
          cd "$RUNNER_TEMP"
          echo "‚¨áÔ∏è Downloading v$VERSION..."
          
          download_task() {
            curl -L --max-time "$CURL_TIMEOUT" --retry 3 -o "$FILENAME" "${BASE_URL}/${FILENAME}" &
            CURL1=$!
            curl -L --max-time "$API_TIMEOUT" --retry 3 -o "$SHA_FILE" "${BASE_URL}/${SHA_FILE}" &
            CURL2=$!
            
            wait $CURL1 || return 1
            wait $CURL2 || return 1
            return 0
          }
          
          retry download_task
          
          # Verify integrity immediately
          verify_archive "$FILENAME" "$SHA_FILE" || { echo "‚ùå Verification failed"; exit 1; }
          
          # Validate size
          SIZE=$(stat -c%s "$FILENAME")
          (( SIZE >= MIN_SIZE_BYTES && SIZE <= MAX_SIZE_BYTES )) || { echo "‚ùå Size out of range: $SIZE bytes"; exit 1; }
          
          # Ensure executable exists
          tar -tzf "$FILENAME" | grep -qE '(^|/)AdGuardHome$' || { echo "‚ùå No executable found"; exit 1; }
          
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "sha_file=$SHA_FILE" >> "$GITHUB_OUTPUT"
          echo "‚úì Download verified"

      - name: Update release
        if: steps.download.outputs.filename
        run: |
          source "$RUNNER_TEMP/workflow_functions.sh"
          
          cd "$RUNNER_TEMP"
          FILENAME="${{ steps.download.outputs.filename }}"
          SHA_FILE="${{ steps.download.outputs.sha_file }}"
          VERSION="${{ steps.version.outputs.version }}"
          
          # Delete existing release
          gh release view v-latest >/dev/null 2>&1 && gh release delete v-latest --yes --cleanup-tag || true
          
          # Create new release
          gh release create v-latest \
            --title "AdGuardHome v${VERSION}" \
            --notes "## AdGuardHome v${VERSION}

**Update time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

**Source:** $REPO

**Architecture:** $ARCH

### Download URL
\`\`\`
https://github.com/${{ github.repository }}/releases/download/v-latest/${FILENAME}
\`\`\`" \
            "$FILENAME"
          
          echo "‚úì Release updated"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify release access
        if: steps.download.outputs.filename
        run: |
          source "$RUNNER_TEMP/workflow_functions.sh"
          
          URL="https://github.com/${{ github.repository }}/releases/download/v-latest/${{ steps.download.outputs.filename }}"
          echo "üîç Testing URL..."
          
          # Wait for CDN propagation
          sleep 10
          
          if retry curl -s -I --max-time 30 "$URL" | head -1 | grep -qE 'HTTP/[0-9.]+ (200|302)'; then
            echo "‚úì URL accessible"
          else
            echo "‚ö†Ô∏è URL may need more time to propagate (non-fatal)"
          fi

      - name: Collect metrics
        if: always()
        id: metrics
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - ${{ steps.init.outputs.start_time || END_TIME }}))
          
          echo "duration=$DURATION" >> "$GITHUB_OUTPUT"
          echo "exit_status=${{ job.status }}" >> "$GITHUB_OUTPUT"
          echo "updated=${{ steps.download.outputs.filename != '' }}" >> "$GITHUB_OUTPUT"

      - name: Cleanup
        if: always()
        run: |
          rm -rf "$RUNNER_TEMP"/AdGuardHome_*.tar.gz "$RUNNER_TEMP"/*.json
          echo "‚úì Cleanup completed"

      - name: Summary
        if: always()
        run: |
          cat << EOF
          ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
          ‚ïë        AdGuardHome Auto Update - Execution Summary          ‚ïë
          ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
          ‚Ä¢ Status: ${{ job.status }}
          ‚Ä¢ Duration: ${{ steps.metrics.outputs.duration || 'N/A' }}s
          ‚Ä¢ Updated: ${{ steps.metrics.outputs.updated || 'false' }}
          ‚Ä¢ Latest Version: ${{ steps.version.outputs.version || 'N/A' }}
          ‚Ä¢ Fixed URL: https://github.com/${{ github.repository }}/releases/download/v-latest/AdGuardHome_${{ env.ARCH }}.tar.gz
          EOF
