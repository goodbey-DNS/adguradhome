name: AdGuardHome Auto Update
# Description: Automatically checks for AdGuardHome updates daily at 6 AM Beijing time (UTC 22:00)
# and maintains a fixed download URL that always points to the latest version.

on:
  schedule:
    - cron: '0 22 * * *'  # 6 AM Beijing Time (UTC+8)
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if version is current'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

env:
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  TIMEOUT: 30
  RETRIES: 3
  RETRY_DELAY_BASE: 5
  MIN_FILE_SIZE: 10000000
  MAX_FILE_SIZE: 50000000
  CURL_MAX_TIME: 300

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: adguard-update
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl
          echo "✓ Tools ready"

      - name: Get latest version
        id: version
        run: |
          set -euo pipefail
          
          get_latest() {
            curl -s --max-time "$TIMEOUT" \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/$REPO/releases/latest" \
              2>/dev/null | jq -r '.tag_name // empty'
          }
          
          VERSION=""
          for i in $(seq 1 "$RETRIES"); do
            VERSION=$(get_latest | sed 's/^v//')
            [[ -n "$VERSION" ]] && break
            echo "Attempt $i failed, retrying..."
            sleep $((RETRY_DELAY_BASE ** i))
          done
          
          [[ -n "$VERSION" ]] || { echo "Error: Cannot get version"; exit 1; }
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "✓ Latest version: $VERSION"

      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          
          RESPONSE=$(curl -s --max-time "$TIMEOUT" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v-latest" \
            2>/dev/null || echo "")
          
          if [[ -z "$RESPONSE" ]] || [[ "$(echo "$RESPONSE" | jq -r '.message // empty')" == "Not Found" ]]; then
            CURRENT="none"
          else
            CURRENT=$(echo "$RESPONSE" | jq -r '.name // "none"' | sed 's/^.*v\([0-9.]*\).*$/\1/' || echo "none")
          fi
          
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "✓ Current version: $CURRENT"

      - name: Check if update needed
        id: check
        run: |
          set -euo pipefail
          
          LATEST="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          FORCE="${{ github.event.inputs.force_update || 'false' }}"
          
          if [[ "$FORCE" == "true" ]] || [[ "$CURRENT" == "none" ]] || [[ "$CURRENT" != "$LATEST" ]]; then
            echo "update=true" >> "$GITHUB_OUTPUT"
            echo "✓ Update needed: $CURRENT → $LATEST"
          else
            echo "update=false" >> "$GITHUB_OUTPUT"
            echo "✓ Already latest: v$LATEST"
          fi

      - name: Download AdGuardHome
        if: steps.check.outputs.update == 'true'
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="AdGuardHome_${ARCH}.tar.gz"
          SHA256SUMS="AdGuardHome_${ARCH}.tar.gz.sha256"
          BASE_URL="https://github.com/${REPO}/releases/download/v${VERSION}"
          
          echo "Downloading v${VERSION}..."
          
          for i in $(seq 1 "$RETRIES"); do
            curl -L --max-time "$CURL_MAX_TIME" -o "$FILENAME" "${BASE_URL}/${FILENAME}" &
            PID1=$!
            curl -L --max-time "$TIMEOUT" -o "$SHA256SUMS" "${BASE_URL}/${SHA256SUMS}" &
            PID2=$!
            
            wait $PID1
            EXIT1=$?
            wait $PID2
            EXIT2=$?
            
            if [[ $EXIT1 -eq 0 && $EXIT2 -eq 0 && -f "$FILENAME" && -f "$SHA256SUMS" ]]; then
              break
            fi
            
            rm -f "$FILENAME" "$SHA256SUMS"
            [[ $i -eq $RETRIES ]] && { echo "Download failed"; exit 1; }
            
            sleep $((RETRY_DELAY_BASE ** i))
          done
          
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "sha256file=$SHA256SUMS" >> "$GITHUB_OUTPUT"
          echo "✓ Download completed"
        id: download

      - name: Verify integrity
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          
          FILENAME="${{ steps.download.outputs.filename }}"
          SHA256FILE="${{ steps.download.outputs.sha256file }}"
          
          [[ -f "$SHA256FILE" && -f "$FILENAME" ]] || { echo "Files missing"; exit 1; }
          
          EXPECTED=$(grep -oE '[a-fA-F0-9]{64}' "$SHA256FILE" | head -n1)
          [[ -n "$EXPECTED" ]] || { echo "Cannot extract SHA256"; exit 1; }
          
          ACTUAL=$(sha256sum "$FILENAME" | awk '{print $1}')
          [[ "$EXPECTED" == "$ACTUAL" ]] || { echo "SHA256 mismatch"; exit 1; }
          
          tar -tzf "$FILENAME" >/dev/null 2>&1 || { echo "Invalid archive"; exit 1; }
          
          SIZE=$(stat -c%s "$FILENAME" 2>/dev/null || echo 0)
          [[ $SIZE -ge $MIN_FILE_SIZE && $SIZE -le $MAX_FILE_SIZE ]] || { echo "File size invalid"; exit 1; }
          
          echo "✓ Verification passed"

      - name: Delete old release
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          
          if gh release view v-latest >/dev/null 2>&1; then
            gh release delete v-latest --yes --cleanup-tag || echo "Warning: Delete failed"
          fi
          
          echo "✓ Old release cleaned"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create release
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="${{ steps.download.outputs.filename }}"
          
          gh release create v-latest \
            --title "AdGuardHome v${VERSION}" \
            --notes "## AdGuardHome v${VERSION}
          
          **Update time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          **Source:** $REPO
          
          **Architecture:** $ARCH
          
          ### Download URL
          https://github.com/${{ github.repository }}/releases/download/v-latest/${FILENAME}" \
            "$FILENAME"
          
          echo "✓ Release created"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test download URL
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          
          FILENAME="${{ steps.download.outputs.filename }}"
          URL="https://github.com/${{ github.repository }}/releases/download/v-latest/${FILENAME}"
          
          sleep 10
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -I --max-time 30 "$URL" 2>/dev/null || echo "000")
          
          case "$HTTP_CODE" in
            200|301|302) echo "✓ URL test passed (HTTP $HTTP_CODE)" ;;
            *) echo "⚠️ URL test warning (HTTP $HTTP_CODE)" ;;
          esac

      - name: Cleanup
        if: always()
        run: rm -f AdGuardHome_*.tar.gz AdGuardHome_*.sha256
