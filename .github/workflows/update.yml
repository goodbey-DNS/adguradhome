name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  REPO: AdguardTeam/AdGuardHome
  ARCH: linux_amd64
  TIMEOUT: 30
  RETRIES: 3

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    concurrency:
      group: adguard-update
      cancel-in-progress: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache API responses
        uses: actions/cache@v4
        with:
          path: ~/.cache/api-responses
          key: api-cache-adguard-${{ github.run_id }}
          restore-keys: |
            api-cache-adguard-

      - name: Setup tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq jq curl
          echo "jq version: $(jq --version)"
          echo "curl version: $(curl --version | head -n1)"

      - name: Get latest version
        id: version
        run: |
          set -euo pipefail
          get_version() {
            curl -s --max-time ${{ env.TIMEOUT }} \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ env.REPO }}/releases/latest" \
              2>/dev/null | jq -r '.tag_name // empty' | sed 's/^v//'
          }
          
          VERSION=""
          for i in $(seq 1 ${{ env.RETRIES }}); do
            VERSION=$(get_version)
            if [[ -n "$VERSION" ]]; then
              echo "Latest version: $VERSION"
              echo "version=$VERSION" >> "$GITHUB_OUTPUT"
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep $((2 ** i))
          done
          
          if [[ -z "$VERSION" ]]; then
            echo "Error: Cannot get version after ${{ env.RETRIES }} attempts"
            exit 1
          fi

      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          CURRENT=$(curl -s --max-time ${{ env.TIMEOUT }} \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/v-latest" \
            2>/dev/null | jq -r '.name // "none"' | grep -oP 'v\K[0-9.]+' || echo "none")
          echo "Current version: $CURRENT"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        id: compare
        run: |
          set -euo pipefail
          LATEST="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          
          echo "=== Version Comparison ==="
          echo "Latest from official: $LATEST"
          echo "Current in repo: $CURRENT"
          echo "========================="
          
          if [[ "$CURRENT" == "none" ]] || [[ "$CURRENT" != "$LATEST" ]]; then
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "Update needed: $CURRENT â†’ $LATEST"
          else
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "Already latest: v$LATEST"
          fi

      - name: Download AdGuardHome
        if: steps.compare.outputs.needs_update == 'true'
        id: download
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="AdGuardHome_${{ env.ARCH }}.tar.gz"
          SHA256SUMS="AdGuardHome_${{ env.ARCH }}.tar.gz.sha256"
          BASE_URL="https://github.com/${{ env.REPO }}/releases/download/v${VERSION}"
          
          for i in $(seq 1 ${{ env.RETRIES }}); do
            if curl -L --max-time 300 --retry 3 --retry-delay 5 -o "$FILENAME" "${BASE_URL}/${FILENAME}" && \
               curl -L --max-time 30 --retry 3 --retry-delay 5 -o "$SHA256SUMS" "${BASE_URL}/${SHA256SUMS}"; then
              [[ -f "$FILENAME" && -f "$SHA256SUMS" ]] && break
            fi
            
            [[ $i -eq ${{ env.RETRIES }} ]] && echo "Error: Download failed" && exit 1
            rm -f "$FILENAME" "$SHA256SUMS"
            sleep $((2 ** i))
          done
          
          echo "filename=$FILENAME" >> "$GITHUB_OUTPUT"
          echo "sha256file=$SHA256SUMS" >> "$GITHUB_OUTPUT"

      - name: Verify download integrity
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          FILENAME="${{ steps.download.outputs.filename }}"
          SHA256FILE="${{ steps.download.outputs.sha256file }}"
          
          [[ -f "$SHA256FILE" && -f "$FILENAME" ]] || { echo "Error: Required files not found"; exit 1; }
          
          EXPECTED_SHA=$(grep -oE '^[a-fA-F0-9]{64}' "$SHA256FILE" | head -n1)
          ACTUAL_SHA=$(sha256sum "$FILENAME" | awk '{print $1}')
          [[ "$EXPECTED_SHA" == "$ACTUAL_SHA" ]] || { echo "Error: SHA256 verification failed"; exit 1; }
          
          tar -tzf "$FILENAME" >/dev/null 2>&1 || { echo "Error: Invalid archive"; exit 1; }
          tar -tzf "$FILENAME" | grep -qE '(^|/)AdGuardHome$' || { echo "Error: Archive does not contain AdGuardHome"; exit 1; }
          
          SIZE=$(stat -c%s "$FILENAME" 2>/dev/null || echo 0)
          [[ $SIZE -ge 10000000 ]] || { echo "Error: File too small (< 10MB)"; exit 1; }
          
          echo "Verification passed"

      - name: Delete old release
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          if gh release view v-latest >/dev/null 2>&1; then
            echo "Deleting existing v-latest release..."
            gh release delete v-latest --yes --cleanup-tag
          else
            echo "No existing v-latest release found"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new release
        if: steps.download.outputs.filename
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          FILENAME="${{ steps.download.outputs.filename }}"
          
          [[ -n "$VERSION" && -f "$FILENAME" ]] || { echo "Error: Missing required data"; exit 1; }
          
          NOTES=$(cat <<EOF
          ## AdGuardHome v${VERSION}
          
          **Update time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          **Source:** ${{ env.REPO }}
          
          **Architecture:** ${{ env.ARCH }}
          
          ### Installation
          \`\`\`bash
          tar -xzf ${FILENAME}
          sudo ./AdGuardHome -s install
          \`\`\`
          
          ### Download URL
          **Fixed download link (always points to latest version):**
          \`\`\`
          https://github.com/${{ github.repository }}/releases/download/v-latest/${FILENAME}
          \`\`\`
          EOF
          )
          
          gh release create v-latest \
            --title "AdGuardHome v${VERSION}" \
            --notes "$NOTES" \
            "$FILENAME"
          
          echo "Release created successfully"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log execution info
        if: always()
        run: |
          echo "=================================="
          echo "Workflow Execution Summary"
          echo "=================================="
          echo "Repository     : ${{ github.repository }}"
          echo "Latest Version : ${{ steps.version.outputs.version }}"
          echo "Current Version: ${{ steps.current.outputs.current }}"
          echo "Needs Update   : ${{ steps.compare.outputs.needs_update }}"
          echo "Job Status     : ${{ job.status }}"
          echo "Timestamp      : $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "=================================="
          echo "Fixed Download URL (never changes):"
          echo "https://github.com/${{ github.repository }}/releases/download/v-latest/AdGuardHome_${{ env.ARCH }}.tar.gz"
          echo "=================================="

      - name: Cleanup
        if: always()
        run: |
          rm -f AdGuardHome_*.tar.gz AdGuardHome_*.sha256
          echo "Cleanup completed"
