name: AdGuardHome Auto Update
on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

permissions:
  contents: read
  releases: write

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # é”å®šåˆ°v4ç‰ˆæœ¬ï¼Œé¿å…ä¾›åº”é“¾é£Žé™©
        
      - name: Get latest version
        id: version
        run: |
          set -euo pipefail
          
          # é…ç½®å‚æ•°
          ARCHITECTURE="linux_amd64"
          API_TIMEOUT=10
          RETRY_COUNT=3
          
          echo "::group::Fetching latest AdGuardHome version"
          
          # é‡è¯•æœºåˆ¶èŽ·å–ç‰ˆæœ¬
          VERSION=""
          for attempt in $(seq 1 $RETRY_COUNT); do
            echo "Attempt $attempt/$RETRY_COUNT..."
            
            VERSION=$(curl -s --max-time $API_TIMEOUT \
              "https://api.github.com/repos/AdguardTeam/AdGuardHome/releases/latest" | \
              jq -r '.tag_name' | sed 's/^v//' || echo "")
            
            if [[ -n "$VERSION" && "$VERSION" != "null" ]]; then
              echo "âœ… Found version: v$VERSION"
              break
            fi
            
            if [[ $attempt -lt $RETRY_COUNT ]]; then
              echo "âš ï¸ Failed, retrying in $((attempt * 2)) seconds..."
              sleep $((attempt * 2))
            fi
          done
          
          # éªŒè¯ç‰ˆæœ¬èŽ·å–ç»“æžœ
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
            echo "âŒ Failed to get version after $RETRY_COUNT attempts"
            exit 1
          fi
          
          # éªŒè¯ç‰ˆæœ¬æ ¼å¼
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "architecture=$ARCHITECTURE" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          
      - name: Get current version
        id: current
        run: |
          set -euo pipefail
          
          echo "::group::Checking current release version"
          
          # èŽ·å–å½“å‰ç‰ˆæœ¬ï¼Œå¢žåŠ é”™è¯¯å¤„ç†
          CURRENT=$(curl -s --max-time 10 \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
            jq -r '.tag_name' | sed 's/^v//' || echo "")
          
          # å¤„ç†ç©ºå€¼æˆ–nullå€¼
          if [[ -z "$CURRENT" || "$CURRENT" == "null" ]]; then
            echo "ðŸ“¦ No current release found, treating as first release"
            CURRENT="0.0.0"
          else
            echo "ðŸ“¦ Current version: v$CURRENT"
          fi
          
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"
          
      - name: Check if update needed
        id: should_update
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          
          echo "::group::Version comparison"
          echo "Latest version: v$VERSION"
          echo "Current version: v$CURRENT"
          
          # æ”¹è¿›çš„ç‰ˆæœ¬æ¯”è¾ƒé€»è¾‘
          if [[ -z "$CURRENT" || "$CURRENT" == "0.0.0" ]]; then
            echo "ðŸ†• No current release or first release"
            echo "should_update=true" >> "$GITHUB_OUTPUT"
          elif [[ "$CURRENT" != "$VERSION" ]]; then
            echo "â¬†ï¸ Update needed: $CURRENT -> $VERSION"
            echo "should_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "âœ… Already latest version: v$VERSION"
            echo "should_update=false" >> "$GITHUB_OUTPUT"
          fi
          echo "::endgroup::"
          
      - name: Download and update
        if: steps.should_update.outputs.should_update == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          ARCHITECTURE="${{ steps.version.outputs.architecture }}"
          DOWNLOAD_TIMEOUT=300
          MIN_FILE_SIZE=10000000  # 10MB
          
          echo "::group::Downloading AdGuardHome v$VERSION"
          
          # æž„å»ºä¸‹è½½URL
          FILENAME="AdGuardHome_${ARCHITECTURE}.tar.gz"
          DOWNLOAD_URL="https://github.com/AdguardTeam/AdGuardHome/releases/download/v${VERSION}/${FILENAME}"
          
          echo "ðŸ“¥ Downloading: $FILENAME"
          echo "ðŸ”— URL: $DOWNLOAD_URL"
          
          # ä¸‹è½½æ–‡ä»¶
          if ! curl -L --max-time $DOWNLOAD_TIMEOUT "$DOWNLOAD_URL" -o "$FILENAME"; then
            echo "âŒ Download failed"
            exit 1
          fi
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨å’Œå¤§å°
          if [[ ! -f "$FILENAME" ]]; then
            echo "âŒ Downloaded file not found"
            exit 1
          fi
          
          FILESIZE=$(stat -c%s "$FILENAME")
          echo "ðŸ“Š File size: $FILESIZE bytes"
          
          if [[ $FILESIZE -lt $MIN_FILE_SIZE ]]; then
            echo "âŒ File too small (minimum: $MIN_FILE_SIZE bytes)"
            exit 1
          fi
          
          echo "âœ… Download successful"
          echo "::endgroup::"
          
      - name: Create release
        if: steps.should_update.outputs.should_update == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          ARCHITECTURE="${{ steps.version.outputs.architecture }}"
          FILENAME="AdGuardHome_${ARCHITECTURE}.tar.gz"
          
          echo "::group::Creating GitHub release"
          
          # åˆ é™¤æ—§çš„latest release
          echo "ðŸ—‘ï¸ Removing old 'latest' release..."
          if gh release delete latest --yes 2>/dev/null; then
            echo "âœ… Old release deleted"
          else
            echo "â„¹ï¸ No existing 'latest' release to delete"
          fi
          
          # åˆ›å»ºæ–°release
          echo "ðŸ“¦ Creating new release..."
          RELEASE_NOTES="## AdGuardHome v${VERSION}\n\n**æž¶æž„**: $ARCHITECTURE  \n**æ–‡ä»¶å¤§å°**: $(stat -c%s "$FILENAME" | numfmt --to=iec) bytes  \n**æ›´æ–°æ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\n\n---\nðŸ¤– è‡ªåŠ¨æ›´æ–°å·¥ä½œæµ"

          if gh release create latest \
            --title "AdGuardHome v${VERSION} ($ARCHITECTURE)" \
            --notes "$RELEASE_NOTES" \
            "$FILENAME"; then
            echo "âœ… Release created successfully"
          else
            echo "âŒ Failed to create release"
            exit 1
          fi
          
          echo "::endgroup::"
          
      - name: Cleanup
        if: always()
        run: |
          echo "::group::Cleanup temporary files"
          
          # æ¸…ç†ä¸‹è½½çš„æ–‡ä»¶
          if ls AdGuardHome_*.tar.gz 1> /dev/null 2>&1; then
            rm -f AdGuardHome_*.tar.gz
            echo "ðŸ§¹ Cleaned up downloaded files"
          else
            echo "â„¹ï¸ No files to clean up"
          fi
          
          echo "âœ… Cleanup completed"
          echo "::endgroup::"
          
      - name: Update summary
        if: always()
        run: |
          set -euo pipefail
          
          VERSION="${{ steps.version.outputs.version }}"
          CURRENT="${{ steps.current.outputs.current }}"
          SHOULD_UPDATE="${{ steps.should_update.outputs.should_update }}"
          
          echo "## AdGuardHome Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Version**: v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Current Version**: v$CURRENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Needed**: $SHOULD_UPDATE" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ steps.version.outputs.architecture }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$SHOULD_UPDATE" == "true" ]]; then
            echo "- **Status**: âœ… Update completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status**: â„¹ï¸ No update needed" >> $GITHUB_STEP_SUMMARY
          fi
